<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geoportal GitHub + Supabase</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; }
        #map { height: 600px; width: 100%; border-radius: 8px; border: 2px solid #333; }
        h1 { text-align: center; color: #333; }
    </style>
</head>
<body>

    <h1>Mi Geoportal: Puntos de Interés en Málaga</h1>
    <p style="text-align:center;">Datos cargados dinámicamente desde <b>Supabase (PostgreSQL + PostGIS)</b></p>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = "https://oxughwuqwusiddtfawzi.supabase.co"; 
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94dWdod3Vxd3VzaWRkdGZhd3ppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2Nzk2NjMsImV4cCI6MjA4MjI1NTY2M30.shuGvcz2fv_AxJEE2GHMYysf87e_ajwO1Ou5FDYokiU";

        // Conexión a Supabase
        const supabase = _supabase.createClient(supabaseUrl, supabaseKey);

        // 1. Inicializar el mapa centrado en Málaga
        const map = L.map('map').setView([36.7213, -4.4214], 14);

        // 2. Añadir capa base (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 3. Función para descargar los puntos de la base de datos
        async function cargarPuntos() {
            // Hacemos una consulta a la tabla 'places'
            const { data, error } = await supabase
                .from('places')
                .select('name, description, location');

            if (error) {
                console.error('Error cargando datos:', error);
                alert('Error al conectar con Supabase. Revisa la consola (F12).');
            }

            if (data) {
                data.forEach(lugar => {
                    // PostGIS devuelve la ubicación en formato GeoJSON
                    // Formato esperado: {type: "Point", coordinates: [longitud, latitud]}
                    
                    if(lugar.location && lugar.location.coordinates) {
                        const [lng, lat] = lugar.location.coordinates; 
                      
                        // GeoJSON es [Lon, Lat]
                        // Leaflet usa [Lat, Lon], así que los invertimos aquí
                        L.marker([lat, lng]).addTo(map)
                            .bindPopup(`<b>${lugar.name}</b><br>${lugar.description}`);
                    }
                });
            }
        }

        // Usamos la funcion
        cargarPuntos();
    </script>
</body>
</html>
