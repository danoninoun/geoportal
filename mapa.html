<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Geoportal GitHub + Supabase</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; }
        #map { height: 600px; width: 100%; border-radius: 8px; border: 2px solid #333; }
        h1 { text-align: center; color: #333; }
    </style>
</head>
<body>

    <h1>Mi Geoportal: Puntos de Interés en Málaga</h1>
    <p style="text-align:center;">Datos cargados desde <b>Supabase</b> (Usando SQL View)</p>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = "https://oxughwuqwusiddtfawzi.supabase.co"; 
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94dWdod3Vxd3VzaWRkdGZhd3ppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2Nzk2NjMsImV4cCI6MjA4MjI1NTY2M30.shuGvcz2fv_AxJEE2GHMYysf87e_ajwO1Ou5FDYokiU";

        const client = supabase.createClient(supabaseUrl, supabaseKey);
        const map = L.map('map').setView([36.7213, -4.4214], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        async function cargarPuntos() {
            const { data, error } = await client
                .from('places_view')
                .select('*');

            if (error) {
                console.error("ERROR:", error);
                alert("Error cargando datos");
                return;
            }

            console.log("Datos limpios:", data);

            data.forEach(lugar => {
                if (lugar.location && lugar.location.coordinates) {
                    const [lng, lat] = lugar.location.coordinates; // GeoJSON es [Lon, Lat]
                    
                    console.log(`Pintando ${lugar.name} en:`, lat, lng);

                    L.circleMarker([lat, lng], {
                        radius: 12,
                        fillColor: "#9b59b6",
                        color: "#ffffff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    })
                    .bindPopup(`<b>${lugar.name}</b><br>${lugar.description}`)
                    .addTo(map);
                }
            });
        }

        cargarPuntos();
    </script>
</body>
</html>